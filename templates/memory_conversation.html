<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<meta name="theme-color" content="#4A90E2">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="RemindMe">
    <title>ì˜¤ëŠ˜ì˜ ì¶”ì–µ ëŒ€í™”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
        }

        .container {
            background: white;
            border-radius: 32px;
            box-shadow: 0 10px 40px rgba(124, 58, 237, 0.15);
            max-width: 850px;
            width: 100%;
            padding: 45px;
            border: 3px solid #f3f4f6;
        }

        h1 {
            color: #7c3aed;
            text-align: center;
            margin-bottom: 35px;
            font-size: 2.6em;
            font-weight: 800;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .photo-container {
            text-align: center;
            margin-bottom: 35px;
            position: relative;
        }

        #current-photo {
            max-width: 100%;
            max-height: 420px;
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(124, 58, 237, 0.2);
            display: none;
            border: 4px solid #f3f4f6;
        }

        #photo-info {
            margin-top: 18px;
            color: #6b7280;
            font-size: 1.15em;
            font-weight: 500;
        }

        .status {
            text-align: center;
            margin: 25px 0;
            font-size: 1.25em;
            color: #4b5563;
            min-height: 35px;
            font-weight: 600;
            padding: 12px 20px;
        }

        .listening {
            color: #dc2626;
            font-weight: 700;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }

        .message {
            margin-bottom: 18px;
            padding: 18px 22px;
            border-radius: 16px;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message {
            background: linear-gradient(135deg, #ddd6fe 0%, #e9d5ff 100%);
            border-left: 5px solid #7c3aed;
        }

        .user-message {
            background: linear-gradient(135deg, #fae8ff 0%, #f5d0fe 100%);
            border-left: 5px solid #a855f7;
        }

        .message-label {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #374151;
        }

        .message-text {
            font-size: 1.2em;
            line-height: 1.7;
            color: #1f2937;
        }

        .button-container {
            display: flex;
            gap: 18px;
            justify-content: center;
            margin-top: 35px;
            flex-wrap: wrap;
        }

        button {
            padding: 22px 42px;
            font-size: 1.35em;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button:hover::before {
            width: 400px;
            height: 400px;
        }

        #start-btn {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        #listen-btn {
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
            display: none;
        }

        #next-photo-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            display: none;
        }

        button:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
        }

        button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button span {
            position: relative;
            z-index: 1;
        }

        .loading {
            display: inline-block;
            width: 22px;
            height: 22px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .decorative-circle {
            position: fixed;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        .circle-1 {
            width: 400px;
            height: 400px;
            top: -100px;
            right: -100px;
        }

        .circle-2 {
            width: 300px;
            height: 300px;
            bottom: -50px;
            left: -50px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.08) 0%, transparent 70%);
        }

        .progress-info {
            text-align: center;
            margin: 15px 0;
            color: #7c3aed;
            font-weight: 600;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="decorative-circle circle-1"></div>
    <div class="decorative-circle circle-2"></div>

    <div class="container">
        <h1>ğŸŒ¸ ì˜¤ëŠ˜ì˜ ì¶”ì–µ ëŒ€í™” ğŸŒ¸</h1>

        <div class="photo-container">
            <img id="current-photo" alt="ì¶”ì–µ ì‚¬ì§„">
            <div id="photo-info"></div>
        </div>

        <div class="progress-info" id="progress-info" style="display: none;"></div>
        <div class="status" id="status">ëŒ€í™” ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>

        <div id="conversation-log" class="chat-box"></div>

        <div class="button-container">
            <button id="start-btn"><span>ëŒ€í™” ì‹œì‘ ğŸ¯</span></button>
            <button id="listen-btn"><span>ë‚´ ì´ì•¼ê¸° ë“¤ë ¤ì£¼ê¸° ğŸ¤</span></button>
            <button id="next-photo-btn"><span>ë‹¤ìŒ ì‚¬ì§„ ë³´ê¸° ğŸ“¸</span></button>
        </div>
    </div>

    <script>
let patientId = localStorage.getItem('user_id');
let currentPhoto = null;
let conversationCount = 0;
let selectedQuestions = []; // ì´ë²ˆ ì„¸ì…˜ì— ì‚¬ìš©í•  ì§ˆë¬¸ë“¤
let totalQuestions = 0; // ì´ ì§ˆë¬¸ ê°œìˆ˜

const synthesis = window.speechSynthesis;
const startBtn = document.getElementById('start-btn');
const listenBtn = document.getElementById('listen-btn');
const nextPhotoBtn = document.getElementById('next-photo-btn');
const statusDiv = document.getElementById('status');
const progressInfo = document.getElementById('progress-info');
const conversationLog = document.getElementById('conversation-log');
const currentPhotoImg = document.getElementById('current-photo');
const photoInfo = document.getElementById('photo-info');

// âœ… ìŒì„±ì¸ì‹ ì„¤ì •
let recognition = null;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'ko-KR';
    recognition.continuous = false;
    recognition.interimResults = false;
}

// âœ… ìŒì„± ì¶œë ¥
function speak(text, callback) {
    synthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ko-KR';
    utter.rate = 0.9;
    utter.onend = () => { if (callback) callback(); };
    synthesis.speak(utter);
}

// âœ… ë©”ì‹œì§€ ì¶”ê°€
function addMessage(type, label, text) {
    const msg = document.createElement('div');
    msg.className = `message ${type}-message`;
    msg.innerHTML = `<div class="message-label">${label}</div><div class="message-text">${text}</div>`;
    conversationLog.appendChild(msg);
    conversationLog.scrollTop = conversationLog.scrollHeight;
}

// âœ… ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
function updateProgress() {
    progressInfo.style.display = 'block';
    progressInfo.textContent = `ğŸ’¬ ì§ˆë¬¸ ${conversationCount} / ${totalQuestions}`;
}

// âœ… ìµœì‹  ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadDailyPhoto() {
    try {
        const response = await fetch('/api/daily_photos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId })
        });
        const data = await response.json();

        const photos = data.memory_photo || [];
        if (photos.length === 0) {
            statusDiv.textContent = 'ğŸ“­ ë³´í˜¸ìê°€ ì˜¬ë¦° ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.';
            return false;
        }

        currentPhoto = photos[0];
        currentPhotoImg.src = `/static/uploads/photos/${currentPhoto.filename}`;
        currentPhotoImg.style.display = 'block';
        photoInfo.textContent = `ğŸ“… ${currentPhoto.photo_date || ''}  ğŸ“ ${currentPhoto.location || ''}`;
        return true;
    } catch (err) {
        console.error('ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
        statusDiv.textContent = 'ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
        return false;
    }
}

// âœ… ì „ì²´ ì§ˆë¬¸ ëª©ë¡
const allQuestions = [
    "ì´ ì‚¬ì§„ì„ ë³´ì‹œë‹ˆ ì–´ë–¤ ìƒê°ì´ ë“œì‹œë‚˜ìš”?",
    "ê·¸ë•Œ ê¸°ë¶„ì´ ì–´ë• ì–´ìš”?",
    "ì´ ì‚¬ì§„ ì† ì‚¬ëŒì€ ëˆ„êµ¬ì¸ê°€ìš”?",
    "ì´ë‚ ì€ ì–´ë–¤ ì¼ì´ ìˆì—ˆë‚˜ìš”?",
    "ì´ ì¥ì†Œê°€ ì–´ë””ì¸ì§€ ê¸°ì–µë‚˜ì‹œë‚˜ìš”?",
    "ì´ ì‚¬ì§„ì„ ì°ì€ ì´ìœ ê°€ ìˆìœ¼ì‹ ê°€ìš”?",
    "ê·¸ë•Œ ë“¤ë¦¬ë˜ ì†Œë¦¬ë‚˜ ëƒ„ìƒˆê°€ ê¸°ì–µë‚˜ì‹œë‚˜ìš”?",
    "ê·¸ ì‹œì ˆì˜ ë‚˜ì—ê²Œ í•œë§ˆë”” í•´ì£¼ì‹ ë‹¤ë©´ìš”?",
    "ì´ ìˆœê°„ì„ í•œ ë‹¨ì–´ë¡œ í‘œí˜„í•œë‹¤ë©´ìš”?",
    "ì´ ì‚¬ì§„ì„ ë³´ë©´ ì–´ë–¤ ë…¸ë˜ê°€ ë– ì˜¤ë¥´ì„¸ìš”?",
    "ì´ ìˆœê°„ì´ ë‹¤ì‹œ ì˜¨ë‹¤ë©´ ì–´ë–¤ ê¸°ë¶„ì¼ê¹Œìš”?",
    "ê·¸ë¶„ê³¼ í•¨ê»˜í•œ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ì¼ì€ ë­ì˜ˆìš”?",
    "ê·¸ë•Œ ê³„ì ˆì´ë‚˜ ë‚ ì”¨ëŠ” ì–´ë• ë‚˜ìš”?",
    "ì´ ì‚¬ì§„ì„ ê·¸ë¦¼ìœ¼ë¡œ ê·¸ë¦°ë‹¤ë©´ ì–´ë–¤ ìƒ‰ìœ¼ë¡œ í‘œí˜„í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?"
];

// âœ… 8ê°œ ì§ˆë¬¸ì„ ëœë¤ìœ¼ë¡œ ì„ íƒ
function selectRandomQuestions() {
    const questionCount = 8; // 8ê°œ ê³ ì •
    totalQuestions = questionCount;

    // ì§ˆë¬¸ ì„ê¸°
    const shuffled = [...allQuestions].sort(() => Math.random() - 0.5);

    // 8ê°œë§Œ ì¶”ì¶œ
    selectedQuestions = shuffled.slice(0, questionCount);

    console.log(`âœ… ì´ ${totalQuestions}ê°œì˜ ì§ˆë¬¸ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

// âœ… ë‹¤ìŒ ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
function getNextQuestion() {
    if (conversationCount >= selectedQuestions.length) {
        return null;
    }
    return selectedQuestions[conversationCount];
}

// âœ… ì§ˆë¬¸í•˜ê¸°
function askNextQuestion() {
    const question = getNextQuestion();

    if (!question) {
        // ëª¨ë“  ì§ˆë¬¸ì´ ëë‚¨
        progressInfo.style.display = 'none';
        statusDiv.textContent = "ì˜¤ëŠ˜ì˜ ëŒ€í™”ë¥¼ ëª¨ë‘ ë§ˆì³¤ì–´ìš” ğŸ’œ ë‚´ì¼ ë˜ ë§Œë‚˜ìš”!";
        listenBtn.style.display = 'none';
        nextPhotoBtn.style.display = 'inline-block';
        speak("ì˜¤ëŠ˜ì˜ ëŒ€í™”ë¥¼ ëª¨ë‘ ë§ˆì³¤ì–´ìš”. ë‚´ì¼ ë˜ ë§Œë‚˜ìš”!");
        return;
    }

    updateProgress();
    addMessage('ai', 'AI ì§ˆë¬¸ ğŸ’­', question);
    speak(question, () => {
        listenBtn.style.display = 'inline-block';
        listenBtn.disabled = false;
        statusDiv.textContent = 'ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš” ğŸ¤';
    });
}

// âœ… ìŒì„± ë“£ê¸° ì‹œì‘
function startListening() {
    if (!recognition) {
        alert('ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    recognition.start();
    statusDiv.innerHTML = '<span class="listening">ğŸ¤ ë“£ê³  ìˆì–´ìš”...</span>';
    listenBtn.disabled = true;
}

// âœ… ìŒì„± ì¸ì‹ ê²°ê³¼ ì²˜ë¦¬
if (recognition) {
    recognition.onresult = async (e) => {
        let userAnswer = e.results[0][0].transcript.trim();

        // âœ… ëì— ë¶™ëŠ” ë¬¼ìŒí‘œ ì œê±° (ìŒì„±ì¸ì‹ ì˜¤ë¥˜ ë°©ì§€)
        if (userAnswer.endsWith('?')) {
            userAnswer = userAnswer.slice(0, -1).trim();
        }

        addMessage('user', 'ë‚´ ì´ì•¼ê¸° ğŸ—£ï¸', userAnswer);
        statusDiv.textContent = 'AIê°€ ìƒê° ì¤‘ì´ì—ìš”...';
        listenBtn.style.display = 'none';

        // AIì˜ ëœë¤ ë°˜ì‘
        const responses = [

  "ì •ë§ ë”°ëœ»í•œ ì´ì•¼ê¸°ë„¤ìš” ğŸ’•",
  "ê·¸ ë§ˆìŒì´ ì „í•´ì ¸ìš” ğŸ˜Š",
  "ì •ë§ ë©‹ì§„ ê¸°ì–µì´ì—ìš” ğŸŒŸ",
  "ë“£ê¸°ë§Œ í•´ë„ ë¯¸ì†Œê°€ ì§€ì–´ì ¸ìš” ğŸ˜„",
  "ê·¸ ì‹œì ˆì˜ ê°ì •ì´ ì°¸ ì•„ë¦„ë‹¤ì›Œìš”.",
  "ì •ë§ í–‰ë³µì´ ëŠê»´ì§€ëŠ” ëŒ€ë‹µì´ì—ìš” ğŸ’•",
  "ê·¸ë•Œì˜ ëª¨ìŠµì´ ëˆˆì•ì— ê·¸ë ¤ì§€ëŠ” ê²ƒ ê°™ì•„ìš”.",
  "ì´ì•¼ê¸°ë¥¼ ë“¤ìœ¼ë‹ˆ ì €ë„ í–‰ë³µí•´ì§€ë„¤ìš” ğŸ˜Š",
  "ê·¸ ìˆœê°„ì˜ ë”°ëœ»í•¨ì´ ì „í•´ì ¸ìš”.",
  "ì •ë§ ì˜í™”ì˜ í•œ ì¥ë©´ ê°™ì•„ìš” ğŸ¬",
  "ê·¸ ì‹œì ˆì˜ ë¶„ìœ„ê¸°ê°€ ì•„ì§ë„ ë‚¨ì•„ìˆë„¤ìš” ğŸŒ·",
  "ê·¸ë•Œì˜ ë¹›ê³¼ ë°”ëŒì´ ëŠê»´ì§€ëŠ” ë“¯í•´ìš” ğŸŒ¿",
  "ê·¸ëŸ° ì¶”ì–µì´ ìˆë‹¤ëŠ” ê±´ ì •ë§ ì†Œì¤‘í•˜ë„¤ìš” ğŸ’œ",
  "ê·¸ë ‡ê²Œ ê¸°ì–µí•˜ê³  ê³„ì‹œë‹¤ë‹ˆ ë©‹ì ¸ìš” âœ¨",
  "ê·¸ë•Œì˜ í–‰ë³µì´ ëŠê»´ì ¸ìš” ğŸŒ¸"
];



        const aiResponse = responses[Math.floor(Math.random() * responses.length)];
        addMessage('ai', 'AI ğŸ’¬', aiResponse);

        speak(aiResponse, () => {
            conversationCount++;

            // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ
            setTimeout(() => {
                askNextQuestion();
            }, 1000);
        });
    };

    recognition.onerror = (e) => {
        console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', e.error);
        statusDiv.textContent = 'ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        listenBtn.disabled = false;
        listenBtn.style.display = 'inline-block';
    };
}

// âœ… ëŒ€í™” ì‹œì‘
async function startConversation() {
    startBtn.disabled = true;

    if (!(await loadDailyPhoto())) {
        return;
    }

    // ì§ˆë¬¸ ëœë¤ ì„ íƒ
    selectRandomQuestions();

    startBtn.style.display = 'none';
    addMessage('ai', 'AI ğŸ’¬', 'ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ì˜ ì¶”ì–µ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?');

    speak('ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ì˜ ì¶”ì–µ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³¼ê¹Œìš”?', () => {
        setTimeout(() => {
            askNextQuestion();
        }, 500);
    });
}

// âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
startBtn.addEventListener('click', startConversation);
listenBtn.addEventListener('click', startListening);

nextPhotoBtn.addEventListener('click', () => {
    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆë¡œìš´ ì„¸ì…˜ ì‹œì‘
});
</script>

</body>
</html>